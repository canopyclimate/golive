package phx

import (
	"encoding/base64"
	"testing"
)

func TestMarshalUnmarshal(t *testing.T) {

	bm := &UploadMsg{
		JoinRef: "join",
		MsgRef:  "msg",
		Topic:   "topic",
		Event:   "event",
		Payload: []byte("payload"),
	}
	bytes, err := bm.MarshalBinary()
	if err != nil {
		t.Fatal(err)
	}

	nm := &UploadMsg{}
	err = nm.UnmarshalBinary(bytes)
	if err != nil {
		t.Fatal(err)
	}
	if !bm.Equal(nm) {
		t.Fatalf("%v != %v", bm, nm)
	}
}

func TestFile(t *testing.T) {
	// decode the base64 encoded file
	file, err := base64.StdEncoding.DecodeString(testFileB64)
	if err != nil {
		t.Fatal(err)
	}

	nm := &UploadMsg{}
	err = nm.UnmarshalBinary(file)
	if err != nil {
		t.Fatal(err)
	}

	if nm.JoinRef != "10" {
		t.Fatalf("JoinRef: %v != %v", nm.JoinRef, "10")
	}
	if nm.MsgRef != "11" {
		t.Fatalf("MsgRef: %v != %v", nm.MsgRef, "11")
	}
	if nm.Topic != "lvu:0" {
		t.Fatalf("Topic: %v != %v", nm.Topic, "lvu:0")
	}
	if nm.Event != "chunk" {
		t.Fatalf("Event: %v != %v", nm.Event, "chunk")
	}

}

const testFileB64 = "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"

func BenchmarkUploadMsgMarshalUnmarshal(b *testing.B) {
	b.ReportAllocs()
	for i := 0; i < b.N; i++ {
		bm := &UploadMsg{
			JoinRef: "join",
			MsgRef:  "msg",
			Topic:   "topic",
			Event:   "event",
			Payload: []byte("payload"),
		}
		out, err := bm.MarshalBinary()
		if err != nil {
			b.Fatal(err)
		}
		u := new(UploadMsg)
		err = u.UnmarshalBinary(out)
		if err != nil {
			b.Fatal(err)
		}
		if !bm.Equal(u) {
			b.Fatalf("round trip mismatch: %v != %v", bm, u)
		}
	}
}
